<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CapCut Tool</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <nav class="navbar">
        <div class="nav-brand">
            <img src="logo.png" alt="CapCut Logo" class="logo">
            <span class="brand-text">CapCut Tool</span>
        </div>
        <div class="nav-items">
            <a href="#" class="nav-item">Capcut Template</a>
            <a href="#" class="nav-item">Capcut Custom</a>
        </div>
    </nav>
    <div class="content">
        <div class="tab-content" id="template-tab">
            <h1>Capcut Template</h1>
            
            <div class="upload-container">
                <div class="upload-area">
                    <i class="fas fa-cloud-upload-alt"></i>
                    <p>Drag & Drop your images or videos here</p>
                    <p>or</p>
                    <label for="file-upload" class="upload-button">Browse Files</label>
                    <input type="file" id="file-upload" accept="image/*,video/*" multiple hidden>
                </div>
            </div>
            
            <div class="thumbnail-container">
                <h2>Uploaded Files</h2>
                <div class="thumbnail-list" id="thumbnail-list">
                    <!-- Thumbnails will be dynamically added here -->
                </div>
                <div class="export-container">
                    <button id="export-button" class="export-button">Export to CapCut</button>
                </div>
            </div>
        </div>

        <div class="tab-content" id="custom-tab" style="display: none;">
            <h1>Capcut Custom</h1>
            <p>Your video editing companion</p>
        </div>
    </div>
    <script>
        // Tab switching functionality
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM fully loaded and parsed');
            
            const navItems = document.querySelectorAll('.nav-item');
            const tabContents = document.querySelectorAll('.tab-content');
            
            navItems.forEach((item, index) => {
                item.addEventListener('click', function(e) {
                    e.preventDefault();
                    
                    // Hide all tab contents
                    tabContents.forEach(tab => {
                        tab.style.display = 'none';
                    });
                    
                    // Show the corresponding tab content
                    if (index === 0) {
                        document.getElementById('template-tab').style.display = 'block';
                    } else if (index === 1) {
                        document.getElementById('custom-tab').style.display = 'block';
                    }
                });
            });
            
            // Set the default tab
            document.getElementById('template-tab').style.display = 'block';
            
            // Close dropdowns when clicking outside
            document.addEventListener('click', function(e) {
                // Close transition dropdowns
                document.querySelectorAll('.transitions-dropdown.show').forEach(dropdown => {
                    // Check if click is outside the dropdown and its button
                    const parentContainer = dropdown.closest('.transitions-container');
                    const transitionButton = parentContainer.querySelector('.transition-button');
                    
                    if (!dropdown.contains(e.target) && !transitionButton.contains(e.target)) {
                        dropdown.classList.remove('show');
                    }
                });
                
                // Close effects dropdowns
                document.querySelectorAll('.effects-dropdown.show').forEach(dropdown => {
                    // Check if click is outside the dropdown and its label
                    const effectsContainer = dropdown.closest('.effects-container');
                    const effectsLabel = effectsContainer.querySelector('.effects-label');
                    
                    if (!dropdown.contains(e.target) && !effectsLabel.contains(e.target)) {
                        dropdown.classList.remove('show');
                    }
                });
            });
            
            // File upload functionality
            const uploadArea = document.querySelector('.upload-area');
            const fileInput = document.getElementById('file-upload');
            const thumbnailList = document.getElementById('thumbnail-list');
            
            // Handle click on upload area
            uploadArea.addEventListener('click', function() {
                fileInput.click();
            });
            
            // Handle drag and drop
            uploadArea.addEventListener('dragover', function(e) {
                e.preventDefault();
                e.stopPropagation();
                uploadArea.classList.add('active');
            });
            
            uploadArea.addEventListener('dragleave', function(e) {
                e.preventDefault();
                e.stopPropagation();
                uploadArea.classList.remove('active');
            });
            
            uploadArea.addEventListener('drop', function(e) {
                console.log('File drop event triggered');
                e.preventDefault();
                e.stopPropagation();
                uploadArea.classList.remove('active');
                
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    console.log('Files dropped: ' + files.length);
                    handleFiles(files);
                }
            });
            
            // Handle file selection
            fileInput.addEventListener('change', function(e) {
                console.log('File input change event triggered');
                const files = this.files;
                if (files.length > 0) {
                    console.log('Files selected: ' + files.length);
                    handleFiles(files);
                }
            });
            
            // Function to handle files
            function handleFiles(files) {
                if (files && files.length > 0) {
                    console.log('Processing ' + files.length + ' files');
                    
                    for (let i = 0; i < files.length; i++) {
                        const file = files[i];
                        
                        // Check if the file is an image or video
                        if (file.type.startsWith('image/') || file.type.startsWith('video/')) {
                            console.log('Creating thumbnail for: ' + file.name);
                            createThumbnail(file);
                        } else {
                            console.log('Unsupported file type: ' + file.type);
                        }
                    }
                    
                    // Reset the file input to allow uploading the same file again
                    fileInput.value = '';
                } else {
                    console.log('No files to process');
                }
            }
            
            // Function to create thumbnail
            function createThumbnail(file) {
                console.log('Starting thumbnail creation for: ' + file.name);
                
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    console.log('FileReader loaded successfully');
                    
                    const thumbnailItem = document.createElement('div');
                    thumbnailItem.className = 'thumbnail-item';
                    thumbnailItem.draggable = true;
                    
                    // Add index number
                    const thumbnailIndex = document.createElement('div');
                    thumbnailIndex.className = 'thumbnail-index';
                    thumbnailIndex.textContent = thumbnailList.children.length + 1;
                    
                    let thumbnail;
                    
                    if (file.type.startsWith('image/')) {
                        console.log('Creating image thumbnail');
                        thumbnail = document.createElement('img');
                        thumbnail.src = e.target.result;
                    } else if (file.type.startsWith('video/')) {
                        console.log('Creating video thumbnail');
                        thumbnail = document.createElement('video');
                        thumbnail.src = e.target.result;
                        // Add poster image for video if you have one
                        thumbnail.setAttribute('controls', 'true');
                    }
                    
                    const thumbnailInfo = document.createElement('div');
                    thumbnailInfo.className = 'thumbnail-info';
                    
                    const fileName = document.createElement('p');
                    fileName.textContent = file.name;
                    
                    const fileSize = document.createElement('p');
                    fileSize.textContent = formatFileSize(file.size);
                    
                    // Create time duration input container
                    const durationContainer = document.createElement('div');
                    durationContainer.className = 'duration-container';
                    
                    // Create duration label
                    const durationLabel = document.createElement('label');
                    durationLabel.className = 'duration-label';
                    durationLabel.textContent = 'Time:';
                    
                    // Create duration input
                    const durationInput = document.createElement('input');
                    durationInput.type = 'number';
                    durationInput.className = 'duration-input';
                    durationInput.value = 5; // Default 5 seconds
                    durationInput.min = 1;
                    durationInput.max = 60;
                    durationInput.step = 1;
                    
                    // Add event listener to update total duration when changed
                    durationInput.addEventListener('change', function() {
                        updateTotalDuration();
                    });
                    
                    // Create duration unit label
                    const durationUnit = document.createElement('span');
                    durationUnit.className = 'duration-unit';
                    durationUnit.textContent = 'seconds';
                    
                    // Add all duration elements
                    durationContainer.appendChild(durationLabel);
                    durationContainer.appendChild(durationInput);
                    durationContainer.appendChild(durationUnit);
                    
                    // Create effects container
                    const effectsContainer = document.createElement('div');
                    effectsContainer.className = 'effects-container';
                    
                    // Create effects label
                    const effectsLabel = document.createElement('div');
                    effectsLabel.className = 'effects-label';
                    effectsLabel.innerHTML = '<i class="fas fa-magic"></i> Effects: <span class="selected-effect">None</span>';
                    effectsLabel.onclick = function(e) {
                        e.stopPropagation();
                        toggleEffectsDropdown(this);
                    };
                    
                    // Create effects dropdown
                    const effectsDropdown = document.createElement('div');
                    effectsDropdown.className = 'effects-dropdown';
                    
                    // Add effects title
                    const effectsTitle = document.createElement('div');
                    effectsTitle.className = 'effects-title';
                    effectsTitle.textContent = 'Select Effect';
                    effectsDropdown.appendChild(effectsTitle);
                    
                    // Add effects list
                    const effectsList = document.createElement('div');
                    effectsList.className = 'effects-list';
                    
                    // Define effects options
                    const effectOptions = [
                        'None', 'Fade', 'Zoom In', 'Zoom Out', 
                        'Blur', 'Black & White', 'Sepia', 'Brightness',
                        'Contrast', 'Saturation', 'Hue Rotate', 'Invert'
                    ];
                    
                    // Add effect options to the list
                    effectOptions.forEach(effect => {
                        const option = document.createElement('div');
                        option.className = 'effect-option';
                        if (effect === 'None') option.classList.add('selected');
                        option.textContent = effect;
                        option.onclick = function(e) {
                            e.stopPropagation();
                            selectEffect(this, effectsLabel);
                            effectsDropdown.classList.remove('show');
                        };
                        effectsList.appendChild(option);
                    });
                    
                    effectsDropdown.appendChild(effectsList);
                    effectsContainer.appendChild(effectsLabel);
                    effectsContainer.appendChild(effectsDropdown);
                    
                    thumbnailInfo.appendChild(fileName);
                    thumbnailInfo.appendChild(fileSize);
                    thumbnailInfo.appendChild(durationContainer);
                    thumbnailInfo.appendChild(effectsContainer);
                    
                    thumbnailItem.appendChild(thumbnailIndex);
                    thumbnailItem.appendChild(thumbnail);
                    thumbnailItem.appendChild(thumbnailInfo);
                    
                    // If there's already at least one item in the list, add transition element before this one
                    if (thumbnailList.children.length > 0) {
                        const transitionsContainer = createTransitionsElement();
                        thumbnailList.appendChild(transitionsContainer);
                    }
                    
                    thumbnailList.appendChild(thumbnailItem);
                    console.log('Thumbnail added to list');
                    
                    // Add drag event listeners
                    setupDragListeners(thumbnailItem);
                    
                    // Update the total duration
                    updateTotalDuration();
                };
                
                reader.onerror = function(error) {
                    console.error('Error reading file:', error);
                };
                
                try {
                    reader.readAsDataURL(file);
                    console.log('Started reading file as data URL');
                } catch (error) {
                    console.error('Exception while reading file:', error);
                }
            }
            
            // Function to create transitions element
            function createTransitionsElement() {
                const transitionsContainer = document.createElement('div');
                transitionsContainer.className = 'transitions-container';
                
                // Create transition button
                const transitionButton = document.createElement('div');
                transitionButton.className = 'transition-button';
                transitionButton.innerHTML = '<i class="fas fa-exchange-alt"></i>';
                transitionButton.onclick = function(e) {
                    e.stopPropagation();
                    toggleTransitionsDropdown(this);
                };
                
                // Create selected transition display
                const selectedTransition = document.createElement('div');
                selectedTransition.className = 'selected-transition';
                selectedTransition.innerHTML = '<i class="fas fa-cut"></i> Cut';
                
                // Create transitions dropdown
                const transitionsDropdown = document.createElement('div');
                transitionsDropdown.className = 'transitions-dropdown';
                
                // Define transition options
                const transitionOptions = [
                    { name: 'Cut', icon: 'fas fa-cut' },
                    { name: 'Fade', icon: 'fas fa-adjust' },
                    { name: 'Dissolve', icon: 'fas fa-water' },
                    { name: 'Wipe Right', icon: 'fas fa-arrow-right' },
                    { name: 'Wipe Left', icon: 'fas fa-arrow-left' },
                    { name: 'Wipe Up', icon: 'fas fa-arrow-up' },
                    { name: 'Wipe Down', icon: 'fas fa-arrow-down' },
                    { name: 'Zoom In', icon: 'fas fa-search-plus' },
                    { name: 'Zoom Out', icon: 'fas fa-search-minus' }
                ];
                
                // Add transition options to the dropdown
                transitionOptions.forEach(option => {
                    const transitionOption = document.createElement('div');
                    transitionOption.className = 'transition-option';
                    transitionOption.innerHTML = `<i class="${option.icon}"></i> ${option.name}`;
                    transitionOption.onclick = function(e) {
                        e.stopPropagation();
                        selectTransition(this, selectedTransition);
                        transitionsDropdown.classList.remove('show');
                    };
                    transitionsDropdown.appendChild(transitionOption);
                });
                
                transitionsContainer.appendChild(transitionButton);
                transitionsContainer.appendChild(selectedTransition);
                transitionsContainer.appendChild(transitionsDropdown);
                
                return transitionsContainer;
            }
            
            // Function to toggle transitions dropdown
            function toggleTransitionsDropdown(button) {
                const dropdown = button.parentNode.querySelector('.transitions-dropdown');
                dropdown.classList.toggle('show');
                
                // Close all other dropdowns
                document.querySelectorAll('.transitions-dropdown.show').forEach(item => {
                    if (item !== dropdown) {
                        item.classList.remove('show');
                    }
                });
                
                document.querySelectorAll('.effects-dropdown.show').forEach(item => {
                    item.classList.remove('show');
                });
            }
            
            // Function to select a transition
            function selectTransition(option, selectedElement) {
                selectedElement.innerHTML = option.innerHTML;
            }
            
            // Function to toggle effects dropdown
            function toggleEffectsDropdown(label) {
                const dropdown = label.nextElementSibling;
                dropdown.classList.toggle('show');
                
                // Close all other dropdowns
                document.querySelectorAll('.effects-dropdown.show').forEach(item => {
                    if (item !== dropdown) {
                        item.classList.remove('show');
                    }
                });
                
                document.querySelectorAll('.transitions-dropdown.show').forEach(item => {
                    item.classList.remove('show');
                });
            }
            
            // Function to select an effect
            function selectEffect(option, labelElement) {
                const effectName = option.textContent;
                labelElement.querySelector('.selected-effect').textContent = effectName;
                
                // Mark this option as selected
                option.parentNode.querySelectorAll('.effect-option').forEach(item => {
                    item.classList.remove('selected');
                });
                option.classList.add('selected');
            }
            
            // Function to setup drag listeners for thumbnail items
            function setupDragListeners(item) {
                item.addEventListener('dragstart', handleDragStart);
                item.addEventListener('dragover', handleDragOver);
                item.addEventListener('dragleave', handleDragLeave);
                item.addEventListener('drop', handleDrop);
                item.addEventListener('dragend', handleDragEnd);
            }
            
            let draggedItem = null;
            
            function handleDragStart(e) {
                draggedItem = this;
                // Set opacity to indicate dragging
                setTimeout(() => {
                    this.style.opacity = '0.4';
                }, 0);
                
                // Required for Firefox
                e.dataTransfer.effectAllowed = 'move';
                e.dataTransfer.setData('text/html', this.innerHTML);
            }
            
            function handleDragOver(e) {
                e.preventDefault();
                // Allow drop
                e.dataTransfer.dropEffect = 'move';
                this.classList.add('drag-over');
                return false;
            }
            
            function handleDragLeave(e) {
                this.classList.remove('drag-over');
            }
            
            function handleDrop(e) {
                e.stopPropagation();
                e.preventDefault();
                
                this.classList.remove('drag-over');
                
                // Don't do anything if dropping the same item we're dragging
                if (draggedItem !== this) {
                    // Only handle drops on thumbnail items, not transitions
                    if (this.classList.contains('thumbnail-item') && draggedItem.classList.contains('thumbnail-item')) {
                        // Get the position of the dragged item and the drop target
                        const items = Array.from(thumbnailList.children).filter(item => 
                            item.classList.contains('thumbnail-item')
                        );
                        const draggedIndex = items.indexOf(draggedItem);
                        const dropIndex = items.indexOf(this);
                        
                        // Find the actual indices in the parent container
                        const allItems = Array.from(thumbnailList.children);
                        const draggedItemIndex = allItems.indexOf(draggedItem);
                        const dropItemIndex = allItems.indexOf(this);
                        
                        if (draggedIndex < dropIndex) {
                            // Moving forward - need to account for transitions
                            // Insert after the next transition (which is right after the drop target)
                            if (dropItemIndex + 1 < allItems.length && 
                                allItems[dropItemIndex + 1].classList.contains('transitions-container')) {
                                thumbnailList.insertBefore(draggedItem, allItems[dropItemIndex + 2]);
                            } else {
                                thumbnailList.insertBefore(draggedItem, this.nextSibling);
                            }
                        } else {
                            // Moving backward
                            thumbnailList.insertBefore(draggedItem, this);
                        }
                        
                        // Reposition transitions
                        reorganizeTransitions();
                        
                        // Update all index numbers
                        updateIndices();
                    }
                }
                
                return false;
            }
            
            // Function to reorganize transitions
            function reorganizeTransitions() {
                // Remove all existing transitions
                document.querySelectorAll('.transitions-container').forEach(item => {
                    item.remove();
                });
                
                // Add transitions between thumbnail items
                const thumbnailItems = Array.from(thumbnailList.children).filter(item => 
                    item.classList.contains('thumbnail-item')
                );
                
                // Add transitions between items (except after the last one)
                for (let i = 0; i < thumbnailItems.length - 1; i++) {
                    const currentItem = thumbnailItems[i];
                    const nextItem = thumbnailItems[i + 1];
                    
                    // Create a new transition element
                    const transitionsContainer = createTransitionsElement();
                    
                    // Find the actual next item in the parent container
                    const allItems = Array.from(thumbnailList.children);
                    const currentItemIndex = allItems.indexOf(currentItem);
                    
                    // Insert after the current item
                    thumbnailList.insertBefore(transitionsContainer, allItems[currentItemIndex + 1]);
                }
            }
            
            function handleDragEnd(e) {
                // Reset opacity of dragged item
                this.style.opacity = '1';
                
                // Remove drag-over class from all items
                document.querySelectorAll('.thumbnail-item').forEach(item => {
                    item.classList.remove('drag-over');
                });
                
                draggedItem = null;
            }
            
            // Function to update all index numbers
            function updateIndices() {
                const items = thumbnailList.querySelectorAll('.thumbnail-item');
                items.forEach((item, index) => {
                    const indexElement = item.querySelector('.thumbnail-index');
                    indexElement.textContent = index + 1;
                });

                // Also update total duration when reordering
                updateTotalDuration();
            }
            
            // Function to add a total duration counter to thumbnail container
            function addTotalDurationCounter() {
                // Check if duration counter already exists
                if (!document.getElementById('total-duration-container')) {
                    const thumbnailContainer = document.querySelector('.thumbnail-container');
                    
                    const totalDurationContainer = document.createElement('div');
                    totalDurationContainer.id = 'total-duration-container';
                    totalDurationContainer.className = 'total-duration-container';
                    
                    const totalDurationLabel = document.createElement('span');
                    totalDurationLabel.className = 'total-duration-label';
                    totalDurationLabel.textContent = 'Total Duration: ';
                    
                    const totalDurationValue = document.createElement('span');
                    totalDurationValue.id = 'total-duration-value';
                    totalDurationValue.className = 'total-duration-value';
                    totalDurationValue.textContent = '0 seconds';
                    
                    totalDurationContainer.appendChild(totalDurationLabel);
                    totalDurationContainer.appendChild(totalDurationValue);
                    
                    // Insert after the "Uploaded Files" heading
                    const heading = thumbnailContainer.querySelector('h2');
                    heading.parentNode.insertBefore(totalDurationContainer, heading.nextSibling);
                }
            }
            
            // Function to update total duration
            function updateTotalDuration() {
                // Make sure duration counter exists
                addTotalDurationCounter();
                
                // Calculate total duration
                let totalDuration = 0;
                const durationInputs = thumbnailList.querySelectorAll('.duration-input');
                durationInputs.forEach(input => {
                    totalDuration += parseInt(input.value) || 0;
                });
                
                // Update the displayed value
                const totalDurationValue = document.getElementById('total-duration-value');
                if (totalDurationValue) {
                    totalDurationValue.textContent = totalDuration + ' seconds';
                }
            }
            
            // Function to format file size
            function formatFileSize(bytes) {
                if (bytes === 0) return '0 Bytes';
                
                const k = 1024;
                const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                
                return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
            }
            
            // CapCut effect and transition mappings
            const capcut = {
                // Effects mapping (name -> effect_id)
                effects: {
                    'None': null,
                    'Fade': '7399470719085595910',
                    'Zoom In': '7399470719085595911',
                    'Zoom Out': '7399470719085595912',
                    'Blur': '7399470719085595913',
                    'Black & White': '7399470719085595914',
                    'Sepia': '7399470719085595915',
                    'Brightness': '7399470719085595916',
                    'Contrast': '7399470719085595917',
                    'Saturation': '7399470719085595918',
                    'Hue Rotate': '7399470719085595919',
                    'Invert': '7399470719085595920'
                },
                
                // Transitions mapping (name -> effect_id)
                transitions: {
                    'Cut': null,
                    'Fade': '7291211157254181377',
                    'Dissolve': '7291211157254181378',
                    'Wipe Right': '7291211157254181379',
                    'Wipe Left': '7291211157254181380',
                    'Wipe Up': '7291211157254181381',
                    'Wipe Down': '7291211157254181382',
                    'Zoom In': '7291211157254181383',
                    'Zoom Out': '7291211157254181384'
                },
                
                // Icon mapping for transitions
                transitionIcons: {
                    'Cut': 'fas fa-cut',
                    'Fade': 'fas fa-adjust',
                    'Dissolve': 'fas fa-water',
                    'Wipe Right': 'fas fa-arrow-right',
                    'Wipe Left': 'fas fa-arrow-left',
                    'Wipe Up': 'fas fa-arrow-up',
                    'Wipe Down': 'fas fa-arrow-down',
                    'Zoom In': 'fas fa-search-plus',
                    'Zoom Out': 'fas fa-search-minus'
                }
            };
            
            // Generate a random UUID for CapCut JSON
            function generateUUID() {
                const pattern = 'XXXXXXXX-XXXX-4XXX-XXXX-XXXXXXXXXXXX';
                return pattern.replace(/X/g, function() {
                    return Math.floor(Math.random() * 16).toString(16).toUpperCase();
                });
            }
            
            // Add export button functionality
            const exportButton = document.getElementById('export-button');
            exportButton.addEventListener('click', exportToCapcut);
            
            // Function to export data to CapCut JSON format
            function exportToCapcut() {
                // Ensure we have media items
                const thumbnailItems = document.querySelectorAll('.thumbnail-item');
                if (thumbnailItems.length === 0) {
                    alert('Please add at least one media file before exporting');
                    return;
                }
                
                // Get the default template
                fetch('draft_content_default.json')
                    .then(response => response.json())
                    .then(templateData => {
                        // Create a deep copy of the template
                        const capcutData = JSON.parse(JSON.stringify(templateData));
                        
                        // Collect all media items, transitions, and effects
                        const mediaItems = [];
                        const transitionElements = document.querySelectorAll('.transitions-container');
                        
                        // Get all thumbnail items
                        const thumbnails = Array.from(thumbnailItems);
                        thumbnails.forEach((item, index) => {
                            // Get media details
                            const img = item.querySelector('img');
                            const video = item.querySelector('video');
                            const fileName = item.querySelector('.thumbnail-info p:first-child').textContent;
                            const duration = parseInt(item.querySelector('.duration-input').value) * 1000000; // Convert to microseconds
                            const effectName = item.querySelector('.selected-effect').textContent;
                            
                            // Get transition (if not the last item)
                            let transitionName = null;
                            if (index < thumbnails.length - 1) {
                                const transitionElement = transitionElements[index];
                                const transitionText = transitionElement.querySelector('.selected-transition').textContent.trim();
                                transitionName = transitionText.split(' ').slice(1).join(' '); // Remove the icon part
                            }
                            
                            mediaItems.push({
                                fileName: fileName,
                                isVideo: !!video,
                                src: img ? img.src : (video ? video.src : null),
                                duration: duration,
                                effect: effectName,
                                transition: transitionName
                            });
                        });
                        
                        // Reset sections that will be populated
                        capcutData.materials.videos = [];
                        capcutData.materials.transitions = [];
                        capcutData.materials.video_effects = [];
                        capcutData.materials.speeds = [];
                        capcutData.materials.placeholder_infos = [];
                        capcutData.materials.vocal_separations = [];
                        capcutData.tracks = [{
                            attribute: 0,
                            flag: 0,
                            id: generateUUID(),
                            is_default_name: true,
                            name: "",
                            segments: [],
                            type: "video"
                        }];
                        
                        // Calculate total duration
                        let totalDuration = 0;
                        mediaItems.forEach(item => {
                            totalDuration += item.duration;
                        });
                        capcutData.duration = totalDuration;
                        
                        // Track IDs to reference later
                        const idMap = {
                            speeds: [],
                            placeholders: [],
                            canvases: [],
                            soundMappings: [],
                            vocalSeparations: [],
                            transitions: [],
                            videoEffects: []
                        };
                        
                        // Create default canvas
                        const canvasId = generateUUID();
                        capcutData.materials.canvases = [{
                            album_image: "",
                            blur: 0.0,
                            color: "",
                            id: canvasId,
                            image: "",
                            image_id: "",
                            image_name: "",
                            source_platform: 0,
                            team_id: "",
                            type: "canvas_color"
                        }];
                        idMap.canvases.push(canvasId);
                        
                        // Create speed element for each media
                        mediaItems.forEach((item, index) => {
                            const speedId = generateUUID();
                            capcutData.materials.speeds.push({
                                curve_speed: null,
                                id: speedId,
                                mode: 0,
                                speed: 1.0,
                                type: "speed"
                            });
                            idMap.speeds.push(speedId);
                            
                            // Create placeholder
                            const placeholderId = generateUUID();
                            capcutData.materials.placeholder_infos.push({
                                error_path: "",
                                error_text: "",
                                id: placeholderId,
                                meta_type: "none",
                                res_path: "",
                                res_text: "",
                                type: "placeholder_info"
                            });
                            idMap.placeholders.push(placeholderId);
                            
                            // Create sound channel mapping
                            const soundMappingId = generateUUID();
                            capcutData.materials.sound_channel_mappings.push({
                                audio_channel_mapping: 0,
                                id: soundMappingId,
                                is_config_open: false,
                                type: ""
                            });
                            idMap.soundMappings.push(soundMappingId);
                            
                            // Create vocal separation
                            const vocalSeparationId = generateUUID();
                            capcutData.materials.vocal_separations.push({
                                choice: 0,
                                id: vocalSeparationId,
                                production_path: "",
                                removed_sounds: [],
                                time_range: null,
                                type: "vocal_separation"
                            });
                            idMap.vocalSeparations.push(vocalSeparationId);
                            
                            // Create transition if needed
                            if (item.transition && item.transition !== 'Cut' && index < mediaItems.length - 1) {
                                const transitionId = generateUUID();
                                const transitionEffectId = capcut.transitions[item.transition];
                                
                                if (transitionEffectId) {
                                    capcutData.materials.transitions.push({
                                        id: transitionId,
                                        effect_id: transitionEffectId,
                                        duration: 866666, // Default duration (about 0.866 seconds)
                                        name: item.transition,
                                        is_overlap: true,
                                        path: "", // Will be configured by CapCut
                                        category_id: "25835",
                                        category_name: "remen",
                                        type: "transition"
                                    });
                                    idMap.transitions.push(transitionId);
                                }
                            }
                            
                            // Create video effect if needed
                            if (item.effect && item.effect !== 'None') {
                                const effectId = generateUUID();
                                const effectEffectId = capcut.effects[item.effect];
                                
                                if (effectEffectId) {
                                    capcutData.materials.video_effects.push({
                                        id: effectId,
                                        effect_id: effectEffectId,
                                        name: item.effect,
                                        type: "video_effect",
                                        category_id: "27296",
                                        category_name: "hot2",
                                        adjust_params: [
                                            { name: "effects_adjust_color", default_value: 0.5, value: 0.5 },
                                            { name: "effects_adjust_sharpen", default_value: 0.25, value: 0.25 },
                                            { name: "effects_adjust_luminance", default_value: 1.0, value: 1.0 },
                                            { name: "effects_adjust_background_animation", default_value: 0.5, value: 0.5 },
                                            { name: "effects_adjust_intensity", default_value: 0.6, value: 0.6 },
                                            { name: "effects_adjust_speed", default_value: 0.33, value: 0.33 }
                                        ],
                                        render_index: 0,
                                        value: 1.0
                                    });
                                    idMap.videoEffects.push(effectId);
                                }
                            }
                        });
                        
                        // Add media items
                        mediaItems.forEach((item, index) => {
                            const mediaId = generateUUID();
                            
                            // Default values
                            const mediaObject = {
                                id: mediaId,
                                type: item.isVideo ? "video" : "photo",
                                material_name: item.fileName,
                                path: "media/" + item.fileName, // Relative path, will be set by CapCut when importing
                                width: 1280, // Default width
                                height: 720, // Default height
                                duration: item.isVideo ? item.duration : 10800000000, // Long duration for images
                                has_audio: item.isVideo,
                                has_sound_separated: false,
                                crop: {
                                    lower_left_x: 0.0,
                                    lower_left_y: 1.0,
                                    lower_right_x: 1.0,
                                    lower_right_y: 1.0,
                                    upper_left_x: 0.0,
                                    upper_left_y: 0.0,
                                    upper_right_x: 1.0,
                                    upper_right_y: 0.0
                                },
                                crop_ratio: "free",
                                crop_scale: 1.0,
                                category_name: "local",
                                check_flag: 62978047
                            };
                            
                            capcutData.materials.videos.push(mediaObject);
                            
                            // Calculate target timerange
                            let startTime = 0;
                            for (let i = 0; i < index; i++) {
                                startTime += mediaItems[i].duration;
                            }
                            
                            // Build extra material references
                            const extraRefs = [
                                idMap.speeds[index],
                                idMap.placeholders[index],
                                idMap.canvases[0],
                                idMap.soundMappings[index],
                                idMap.vocalSeparations[index]
                            ];
                            
                            // Add transition if it exists
                            if (index < idMap.transitions.length && idMap.transitions[index]) {
                                extraRefs.push(idMap.transitions[index]);
                            }
                            
                            // Create segment
                            const segmentId = generateUUID();
                            const segment = {
                                id: segmentId,
                                material_id: mediaId,
                                target_timerange: {
                                    start: startTime,
                                    duration: item.duration
                                },
                                source_timerange: {
                                    start: 0,
                                    duration: item.duration
                                },
                                extra_material_refs: extraRefs,
                                enable_adjust: true,
                                enable_color_curves: true,
                                enable_color_wheels: true,
                                enable_lut: true,
                                enable_video_mask: true,
                                speed: 1.0,
                                volume: 1.0,
                                visible: true,
                                clip: {
                                    alpha: 1.0,
                                    flip: {
                                        horizontal: false,
                                        vertical: false
                                    },
                                    rotation: 0.0,
                                    scale: {
                                        x: 1.0,
                                        y: 1.0
                                    },
                                    transform: {
                                        x: 0.0,
                                        y: 0.0
                                    }
                                }
                            };
                            
                            capcutData.tracks[0].segments.push(segment);
                        });
                        
                        // Add effect tracks if needed
                        if (idMap.videoEffects.length > 0) {
                            const effectTrack = {
                                id: generateUUID(),
                                type: "effect",
                                segments: []
                            };
                            
                            // Add effect segments
                            idMap.videoEffects.forEach((effectId, index) => {
                                const startTime = 0;
                                for (let i = 0; i < index; i++) {
                                    startTime += mediaItems[i].duration;
                                }
                                
                                effectTrack.segments.push({
                                    id: generateUUID(),
                                    material_id: effectId,
                                    target_timerange: {
                                        start: startTime,
                                        duration: mediaItems[index].duration
                                    },
                                    render_index: 11000,
                                    track_render_index: 1,
                                    visible: true,
                                    volume: 1.0
                                });
                            });
                            
                            capcutData.tracks.push(effectTrack);
                        }
                        
                        // Download the JSON file
                        const jsonString = JSON.stringify(capcutData);
                        const blob = new Blob([jsonString], { type: 'application/json' });
                        const url = URL.createObjectURL(blob);
                        
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = 'draft_content_new.json';
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        URL.revokeObjectURL(url);
                        
                        alert('File exported successfully! Import it to CapCut to use your template.');
                    })
                    .catch(error => {
                        console.error('Error loading template:', error);
                        alert('Error creating CapCut file. Please make sure draft_content_default.json exists.');
                    });
            }
        });
    </script>
</body>
</html> 